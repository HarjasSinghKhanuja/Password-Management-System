<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>ğŸ”‘Password Management SystemğŸ”’</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
</head>

<body>
<div class="container">

    <h2>ğŸ”‘Password Management SystemğŸ”’</h2>

    <form method="POST">
        <input type="password" name="password" id="main-password" placeholder="Enter your password" required>
        <button type="button" id="copy-btn" style="display:none; margin-left:5px;">ğŸ“‹</button>

        <!-- â­ Strong Password Generator -->
        <div class="generator">
            <p class="generator-title"><b>Strong Password Generator</b></p>

            <div class="generator-row">
                <label>Length: <span id="gen-length-value">16</span></label>
                <input type="range" id="gen-length" min="8" max="32" value="16">
            </div>

            <div class="generator-row generator-options">
                <label><input type="checkbox" id="gen-upper" checked> Uppercase</label>
                <label><input type="checkbox" id="gen-lower" checked> Lowercase</label>
                <label><input type="checkbox" id="gen-digits" checked> Numbers</label>
                <label><input type="checkbox" id="gen-symbols" checked> Symbols</label>
            </div>

            <button type="button" id="generate-btn">Generate Strong Password</button>
        </div>

        <button type="submit">Check</button>
    </form>

    {% if result %}
    <div class="output">
        <h3>Strength: {{ result }}</h3>
        <p><b>Breach Check:</b> {{ breach_status }}</p>

        {% if suggestions %}
        <h4>Suggestions:</h4>
        <ul>
            {% for s in suggestions %}
            <li>{{ s }}</li>
            {% endfor %}
        </ul>
        {% endif %}
    </div>
    {% endif %}

    <hr>

    <!-- Vault + Passkey Buttons -->
    <button type="button" id="open-vault-btn">ğŸ”Open Password VaultğŸ”</button>
    <button type="button" id="open-passkey-btn">ğŸ”‘Open Passkey ManagerğŸ”‘</button>

</div>

<!-- ================= VAULT MODAL ================= -->
<div id="vaultModal" class="modal">
  <div class="modal-content">
    <span class="close" id="close-vault">&times;</span>
    <h3>Password Vault</h3>

    <input type="text" id="vault-site" placeholder="Website">
    <input type="text" id="vault-username" placeholder="Username / Email">
    <input type="password" id="vault-password" placeholder="Password">

    <button type="button" id="save-btn">ğŸ’¾SaveğŸ’¾</button>
    <button type="button" id="autofill-btn">âš¡Autofillâš¡</button>
    <button type="button" id="load-passwords-btn">ğŸ“‚View StoredğŸ“‚</button>

    <div id="password-list"></div>
  </div>
</div>

<!-- ================= PASSKEY MODAL ================= -->
<div id="passkeyModal" class="modal">
  <div class="modal-content">
    <span class="close" id="close-passkey">&times;</span>
    <h3>Passkey Manager</h3>

    <input type="text" id="passkey-site" placeholder="Website">
    <button type="button" id="create-passkey-btn">ğŸ”‘Generate PasskeyğŸ”‘</button>
    <button type="button" id="load-passkeys-btn">ğŸ“‚View StoredğŸ“‚</button>

    <div id="passkey-list"></div>
  </div>
</div>

<!-- ================= JAVASCRIPT ================= -->
<script>
document.addEventListener("DOMContentLoaded", function () {

    const passwordInput = document.getElementById("main-password");
    const copyBtn = document.getElementById("copy-btn");

    const container = document.querySelector('.container');
    const form = document.querySelector('form');

    /* ================= LIVE STRENGTH METER ================= */

    const strengthText = document.createElement('p');
    strengthText.style.fontWeight = 'bold';

    const strengthBar = document.createElement('div');
    strengthBar.style.height = '8px';
    strengthBar.style.borderRadius = '4px';
    strengthBar.style.marginTop = '5px';
    strengthBar.style.transition = 'width 0.3s ease, background-color 0.3s ease';

    const breachText = document.createElement('p');
    breachText.style.marginTop = '5px';
    breachText.style.fontSize = '14px';

    container.insertBefore(strengthText, form.nextSibling);
    container.insertBefore(strengthBar, strengthText.nextSibling);
    container.insertBefore(breachText, strengthBar.nextSibling);

    function evaluateStrength(password) {
        let score = 0;
        if (password.length >= 8) score++;
        if (/[A-Z]/.test(password)) score++;
        if (/[a-z]/.test(password)) score++;
        if (/[0-9]/.test(password)) score++;
        if (/[@$!%*?&]/.test(password)) score++;
        return score;
    }

    passwordInput.addEventListener('input', async function () {

        const password = passwordInput.value;
        copyBtn.style.display = password.length > 0 ? "inline-block" : "none";

        const score = evaluateStrength(password);

        let color = '', text = '';
        if (score <= 1) { color = 'red'; text = 'âš ï¸Weakâš ï¸'; }
        else if (score <= 3) { color = 'orange'; text = 'ğŸ˜MediumğŸ‘'; }
        else { color = 'green'; text = 'ğŸ’ªStrongğŸ’¯'; }

        strengthText.textContent = password ? `Password Strength: ${text}` : '';
        strengthBar.style.width = `${(score/5)*100}%`;
        strengthBar.style.backgroundColor = color;

        /* ===== BREACH CHECK ===== */
       if (password.length > 5) {
            const sha1 = await crypto.subtle.digest(
                "SHA-1",
                new TextEncoder().encode(password)
            );
            const hashArray = Array.from(new Uint8Array(sha1));
            const hashHex = hashArray.map(b =>
                b.toString(16).padStart(2, "0")
            ).join("").toUpperCase();

            const prefix = hashHex.slice(0,5);
            const suffix = hashHex.slice(5);

            try {
                const res = await fetch(
                    `https://api.pwnedpasswords.com/range/${prefix}`
                );
                const text = await res.text();

                if (text.includes(suffix)) {
                    breachText.textContent = "ğŸš¨Found in Data BreachesğŸš¨";
                    breachText.style.color = "red";
                } else {
                    breachText.textContent = "âœ…Not Found in Data Breachesâœ…";
                    breachText.style.color = "green";
                }

            } catch {
                breachText.textContent = "âš !Breach Check Unavailable!âš ";
            }
        }
    });

    copyBtn.addEventListener("click", function () {
        navigator.clipboard.writeText(passwordInput.value);
        copyBtn.textContent = "âœ”";
        setTimeout(() => copyBtn.textContent = "ğŸ“‹", 1000);
    });

    /* ================= PASSWORD GENERATOR ================= */

    const genLength = document.getElementById("gen-length");
    const genLengthValue = document.getElementById("gen-length-value");
    const genUpper = document.getElementById("gen-upper");
    const genLower = document.getElementById("gen-lower");
    const genDigits = document.getElementById("gen-digits");
    const genSymbols = document.getElementById("gen-symbols");
    const generateBtn = document.getElementById("generate-btn");

    genLength.addEventListener("input", () => {
        genLengthValue.textContent = genLength.value;
    });

    function generateStrongPassword() {
        const length = parseInt(genLength.value);
        const sets = [];
        if (genUpper.checked) sets.push("ABCDEFGHIJKLMNOPQRSTUVWXYZ");
        if (genLower.checked) sets.push("abcdefghijklmnopqrstuvwxyz");
        if (genDigits.checked) sets.push("0123456789");
        if (genSymbols.checked) sets.push("@$!%*?&");

        if (sets.length === 0) {
            alert("Select at least one character type.");
            return "";
        }

        const all = sets.join("");
        let pwd = [];

        sets.forEach(set => {
            pwd.push(set[Math.floor(Math.random()*set.length)]);
        });

        while (pwd.length < length) {
            pwd.push(all[Math.floor(Math.random()*all.length)]);
        }

        return pwd.sort(() => Math.random() - 0.5).join("");
    }

    generateBtn.addEventListener("click", function () {
        const pwd = generateStrongPassword();
        if (!pwd) return;
        passwordInput.value = pwd;
        passwordInput.dispatchEvent(new Event("input"));
    });

    /* ================= MODALS ================= */

    const vaultModal = document.getElementById("vaultModal");
    const passkeyModal = document.getElementById("passkeyModal");

    document.getElementById("open-vault-btn").onclick = () => vaultModal.style.display = "block";
    document.getElementById("close-vault").onclick = () => vaultModal.style.display = "none";

    document.getElementById("open-passkey-btn").onclick = () => passkeyModal.style.display = "block";
    document.getElementById("close-passkey").onclick = () => passkeyModal.style.display = "none";

    window.onclick = function(event) {
        if (event.target === vaultModal) vaultModal.style.display = "none";
        if (event.target === passkeyModal) passkeyModal.style.display = "none";
    };

/* ================= AUTOFILL FIX ================= */

document.getElementById("autofill-btn").onclick = function () {

    const site = document.getElementById("vault-site").value.trim().toLowerCase();

    if (!site) {
        alert("Please enter a website.");
        return;
    }

    fetch("/autofill", {
        method: "POST",
        headers: {
            "Content-Type": "application/x-www-form-urlencoded"
        },
        body: `site=${encodeURIComponent(site)}`
    })
    .then(res => res.json())
    .then(data => {

        if (data.status === "success") {
            document.getElementById("vault-username").value = data.username;
            document.getElementById("vault-password").value = data.password;
        } 
        else if (data.status === "not_found") {
            alert("No saved credentials found for this site.");
        } 
        else {
            alert(data.message || "Autofill failed.");
        }
    })
    .catch(error => {
        console.error("Autofill error:", error);
        alert("Server error during autofill.");
    });
};

    /* ================= VAULT API ================= */

    document.getElementById("save-btn").onclick = function () {
        const site = document.getElementById("vault-site").value;
        const username = document.getElementById("vault-username").value;
        const password = document.getElementById("vault-password").value;

        fetch("/save-password", {
            method: "POST",
            headers: {"Content-Type":"application/x-www-form-urlencoded"},
            body: `site=${site}&username=${username}&password=${password}`
        }).then(() => alert("Password Saved ğŸ”"));
    };

    document.getElementById("load-passwords-btn").onclick = function () {
        fetch("/get-passwords")
        .then(res => res.json())
        .then(response => {
            const list = document.getElementById("password-list");
            list.innerHTML = "";

            if(response.status !== "success"){
                list.innerHTML = "Error loading passwords.";
                return;
            }

            if(response.data.length === 0){
                list.innerHTML = "No saved passwords.";
                return;
            }

            response.data.forEach(p => {
                list.innerHTML += `<div><b>${p.site}</b><br>${p.username}</div>`;
            });
        });
    };

    /* ================= PASSKEY API ================= */

    document.getElementById("create-passkey-btn").onclick = function () {
        const site = document.getElementById("passkey-site").value;

        fetch("/create-passkey", {
            method: "POST",
            headers: {"Content-Type":"application/x-www-form-urlencoded"},
            body: `site=${site}`
        })
        .then(res => res.json())
        .then(d => alert("Generated Passkey:\n" + d.passkey));
    };

    document.getElementById("load-passkeys-btn").onclick = function () {
        fetch("/get-passkeys")
        .then(res => res.json())
        .then(data => {
            const list = document.getElementById("passkey-list");
            list.innerHTML = "";
            data.forEach(p => {
                list.innerHTML += `<div><b>${p.site}</b><br>${p.passkey}</div>`;
            });
        });
    };

});
</script>

</body>
</html>